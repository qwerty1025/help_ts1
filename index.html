<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>配送管理系統 - iPhone 15 Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root { --safe-area-bottom: 34px; }
        body { background-color: #f1f5f9; -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .ios-tab-content { height: calc(100vh - 160px); overflow-y: auto; padding-bottom: 120px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; background: #e2e8f0; border: 1px solid #e2e8f0; }
        .calendar-day { aspect-ratio: 1/1.2; background: white; padding: 4px; font-size: 12px; position: relative; }
        /* 狀態顏色 */
        .state-pending { background-color: #fef08a; } /* 備貨確認 - 黃 */
        .state-success { background-color: #bbf7d0; } /* 已送達 - 綠 */
        .state-fail { background-color: #fecaca; }    /* 未送達 - 紅 */
    </style>
</head>
<body>

    <div id="app" class="max-w-[430px] mx-auto min-h-screen bg-slate-50 relative">
        
        <header class="bg-white border-b border-slate-200 p-4 sticky top-0 z-30">
            <div class="flex justify-between items-center">
                <h1 class="text-xl font-bold text-slate-800">{{ currentTitle }}</h1>
                <div class="text-indigo-600 font-mono font-bold">{{ todayStr }}</div>
            </div>
        </header>

        <main class="ios-tab-content p-3">
            
            <div v-if="activeTab === 'A'" class="space-y-4">
                <div v-for="(customers, block) in groupedDailyTasks" :key="block">
                    <h3 class="text-xs font-black text-slate-400 mb-2 ml-1 uppercase tracking-widest">{{ block }}</h3>
                    <div v-for="c in customers" :key="c.id" 
                        @click="toggleStatus(c.id, todayKey)"
                        :class="['bg-white rounded-2xl p-4 mb-2 shadow-sm flex justify-between items-center border-l-8 transition-all', getStatusClass(c.id, todayKey)]">
                        <div>
                            <div class="font-bold text-slate-800">{{ c.name }}</div>
                            <div class="text-xs text-slate-500">{{ c.flavor }} | {{ c.count }} 瓶</div>
                        </div>
                        <div class="text-right">
                            <i :class="getStatusIcon(c.id, todayKey)"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="activeTab === 'B'">
                <div class="bg-white rounded-2xl p-3 shadow-sm mb-4">
                    <label class="text-[10px] font-bold text-slate-400 block mb-1">選擇訂戶</label>
                    <select v-model="selectedCustomerId" class="w-full bg-slate-50 p-2 rounded-lg font-bold outline-none border-none">
                        <option v-for="c in mockCustomers" :key="c.id" :value="c.id">{{ c.name }} ({{ c.blockId }})</option>
                    </select>
                </div>

                <div class="bg-indigo-700 text-white rounded-2xl p-4 shadow-lg mb-4">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <div class="text-xs opacity-70">本月預計收費</div>
                            <div class="text-3xl font-black">NT$ {{ calculateTotal }}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-xs opacity-70">單價</div>
                            <input type="number" v-model="pricePerBottle" class="bg-indigo-800 w-16 text-center rounded border-none text-lg font-bold">
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button @click="setPattern('all')" class="flex-1 bg-white/20 hover:bg-white/30 py-2 rounded-lg text-xs font-bold transition">每日配送</button>
                        <button @click="setPattern('weekday')" class="flex-1 bg-white/20 hover:bg-white/30 py-2 rounded-lg text-xs font-bold transition">平日(1-5)</button>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-sm overflow-hidden border border-slate-200">
                    <div class="bg-slate-50 p-2 grid grid-cols-7 text-center text-[10px] font-bold text-slate-400 border-b">
                        <div v-for="d in ['日','一','二','三','四','五','六']">{{ d }}</div>
                    </div>
                    <div class="calendar-grid">
                        <div v-for="day in calendarDays" :key="day.date" 
                            @click="day.date && toggleStatus(selectedCustomerId, day.dateKey)"
                            :class="['calendar-day cursor-pointer', day.date ? getStatusClass(selectedCustomerId, day.dateKey) : 'bg-slate-50']">
                            <span class="font-bold">{{ day.date }}</span>
                            <div v-if="day.date && isDeliveryDay(selectedCustomerId, day.dateKey)" class="absolute bottom-1 right-1 text-[10px] text-slate-500 font-bold">
                                {{ getCustomer(selectedCustomerId).count }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="activeTab === 'C' || activeTab === 'D'" class="text-center py-20 text-slate-400">
                功能模組載入中...
            </div>

        </main>

        <nav class="fixed bottom-0 w-full max-w-[430px] bg-white/90 backdrop-blur-xl border-t border-slate-200 px-4 pt-3 pb-[var(--safe-area-bottom)] flex justify-between z-40">
            <button @click="activeTab = 'A'" :class="['flex flex-col items-center gap-1 w-1/4', activeTab === 'A' ? 'text-indigo-600' : 'text-slate-400']">
                <i class="fa-solid fa-list-check text-xl"></i>
                <span class="text-[10px] font-bold">當日檢視</span>
            </button>
            <button @click="activeTab = 'B'" :class="['flex flex-col items-center gap-1 w-1/4', activeTab === 'B' ? 'text-indigo-600' : 'text-slate-400']">
                <i class="fa-solid fa-calendar-days text-xl"></i>
                <span class="text-[10px] font-bold">訂戶月曆</span>
            </button>
            <button @click="activeTab = 'C'" :class="['flex flex-col items-center gap-1 w-1/4', activeTab === 'C' ? 'text-indigo-600' : 'text-slate-400']">
                <i class="fa-solid fa-calculator text-xl"></i>
                <span class="text-[10px] font-bold">簡單估價</span>
            </button>
            <button @click="activeTab = 'D'" :class="['flex flex-col items-center gap-1 w-1/4', activeTab === 'D' ? 'text-indigo-600' : 'text-slate-400']">
                <i class="fa-solid fa-file-contract text-xl"></i>
                <span class="text-[10px] font-bold">停送摘要</span>
            </button>
        </nav>
    </div>

    <script type="module">
        const { createApp, ref, computed, reactive, onMounted } = Vue;

        createApp({
            setup() {
                const activeTab = ref('A');
                const selectedCustomerId = ref(1);
                const pricePerBottle = ref(30);
                
                // 狀態紀錄: { customerId: { dateKey: status } } 
                // status: 0:備貨, 1:送達, 2:未送達, null:未設定
                const deliveryLog = reactive({}); 

                // 模擬從 Google Sheet 取得的訂戶資料
                const mockCustomers = ref([
                    { id: 1, name: '大埔姑婆', blockId: '大埔路段', flavor: '原味', count: 70, freq: [1,2,3,4,5,6,0] },
                    { id: 2, name: '詹_豬肉燈', blockId: '菜市場', flavor: '甜', count: 9, freq: [1,2,3,4,5] },
                    { id: 3, name: '水牛伯', blockId: '大埔路段', flavor: '巧', count: 2, freq: [2,4] },
                    { id: 4, name: '中園街陳小姐', blockId: '中園街', flavor: '黑糖', count: 5, freq: [1,3,5] }
                ]);

                // 日期相關工具
                const now = new Date();
                const todayKey = now.toISOString().split('T')[0];
                const todayStr = now.toLocaleDateString('zh-TW', { month: 'long', day: 'numeric', weekday: 'short' });

                const currentTitle = computed(() => {
                    const titles = { A: '今日配送清單', B: '個人月曆管家', C: '自動試算工具', D: '停送紀錄摘要' };
                    return titles[activeTab.value];
                });

                // 視角 1: 當天任務分組
                const groupedDailyTasks = computed(() => {
                    const dayOfWeek = now.getDay();
                    const filtered = mockCustomers.value.filter(c => c.freq.includes(dayOfWeek));
                    return filtered.reduce((groups, item) => {
                        if (!groups[item.blockId]) groups[item.blockId] = [];
                        groups[item.blockId].push(item);
                        return groups;
                    }, {});
                });

                // 視角 2: 月曆生成
                const calendarDays = computed(() => {
                    const year = now.getFullYear();
                    const month = now.getMonth();
                    const firstDay = new Date(year, month, 1).getDay();
                    const totalDays = new Date(year, month + 1, 0).getDate();
                    
                    const days = [];
                    for (let i = 0; i < firstDay; i++) days.push({ date: null });
                    for (let i = 1; i <= totalDays; i++) {
                        const d = new Date(year, month, i);
                        days.push({
                            date: i,
                            dateKey: d.toISOString().split('T')[0]
                        });
                    }
                    return days;
                });

                // 狀態切換邏輯 (備貨確認 -> 已送達 -> 未送達 -> 取消)
                const toggleStatus = (cid, dateKey) => {
                    if (!deliveryLog[cid]) deliveryLog[cid] = {};
                    const current = deliveryLog[cid][dateKey];
                    if (current === undefined || current === null) deliveryLog[cid][dateKey] = 0;
                    else if (current === 0) deliveryLog[cid][dateKey] = 1;
                    else if (current === 1) deliveryLog[cid][dateKey] = 2;
                    else delete deliveryLog[cid][dateKey];
                };

                const getStatusClass = (cid, dateKey) => {
                    const status = deliveryLog[cid]?.[dateKey];
                    if (status === 0) return 'border-yellow-400 bg-yellow-50';
                    if (status === 1) return 'border-emerald-500 bg-emerald-50';
                    if (status === 2) return 'border-red-400 bg-red-50';
                    return 'border-slate-100';
                };

                const getStatusIcon = (cid, dateKey) => {
                    const status = deliveryLog[cid]?.[dateKey];
                    if (status === 0) return 'fa-solid fa-box text-yellow-500';
                    if (status === 1) return 'fa-solid fa-circle-check text-emerald-500';
                    if (status === 2) return 'fa-solid fa-circle-xmark text-red-400';
                    return 'fa-solid fa-circle text-slate-100';
                };

                const isDeliveryDay = (cid, dateKey) => {
                    const customer = mockCustomers.value.find(c => c.id === cid);
                    if (!customer) return false;
                    const d = new Date(dateKey);
                    return customer.freq.includes(d.getDay());
                };

                // 金額試算
                const calculateTotal = computed(() => {
                    const cid = selectedCustomerId.value;
                    const customer = mockCustomers.value.find(c => c.id === cid);
                    if (!customer) return 0;
                    
                    // 找出該月所有已標註為 1 (已送達) 的天數
                    let deliveredCount = 0;
                    if (deliveryLog[cid]) {
                        Object.keys(deliveryLog[cid]).forEach(dateKey => {
                            if (deliveryLog[cid][dateKey] === 1) deliveredCount++;
                        });
                    }
                    return deliveredCount * customer.count * pricePerBottle.value;
                });

                // 一鍵設定模式 (平日/每日)
                const setPattern = (type) => {
                    const cid = selectedCustomerId.value;
                    const customer = mockCustomers.value.find(c => c.id === cid);
                    if (!deliveryLog[cid]) deliveryLog[cid] = {};
                    
                    calendarDays.value.forEach(day => {
                        if (!day.date) return;
                        const d = new Date(day.dateKey);
                        const isWeekday = [1,2,3,4,5].includes(d.getDay());
                        
                        if (type === 'all' || (type === 'weekday' && isWeekday)) {
                            deliveryLog[cid][day.dateKey] = 1; // 預設全部設為已送達，方便後續微調
                        }
                    });
                };

                const getCustomer = (id) => mockCustomers.value.find(c => c.id === id);

                return { 
                    activeTab, currentTitle, todayStr, todayKey,
                    groupedDailyTasks, mockCustomers, selectedCustomerId, 
                    calendarDays, toggleStatus, getStatusClass, getStatusIcon,
                    isDeliveryDay, pricePerBottle, calculateTotal, getCustomer,
                    setPattern, deliveryLog
                };
            }
        }).mount('#app');
    </script>
</body>
</html>